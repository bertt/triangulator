using NUnit.Framework;
using System.IO;
using Wkx;

namespace Triangulate.Tests
{
    public class Tests
    {
        [Test]
        public void MultipolygonZTriangulateTest()
        {
            // arrange
            var buildingWkt = "MULTIPOLYGON Z(((43603.770435546874 361514.6418164063 1.2790000438690186,43603.50600073242 361509.7590039063 1.2790000438690186,43598.60899755859 361510.0461132813 1.2790000438690186,43603.770435546874 361514.6418164063 1.2790000438690186)),((43599.11101171875 361520.242890625 1.2790000438690186,43604.058002685546 361519.95211914065 1.2790000438690186,43598.85057470703 361514.95309570315 1.2790000438690186,43599.11101171875 361520.242890625 1.2790000438690186)),((43598.85057470703 361514.95309570315 1.2790000438690186,43603.770435546874 361514.6418164063 1.2790000438690186,43598.60899755859 361510.0461132813 1.2790000438690186,43598.85057470703 361514.95309570315 1.2790000438690186)),((43604.058002685546 361519.95211914065 1.2790000438690186,43603.770435546874 361514.6418164063 1.2790000438690186,43598.85057470703 361514.95309570315 1.2790000438690186,43604.058002685546 361519.95211914065 1.2790000438690186)),((43598.60899755859 361510.0461132813 6.778176307678223,43598.85057470703 361514.95309570315 7.397906303405762,43598.85057470703 361514.95309570315 1.2790000438690186,43598.60899755859 361510.0461132813 6.778176307678223)),((43598.60899755859 361510.0461132813 1.2790000438690186,43598.60899755859 361510.0461132813 6.778176307678223,43598.85057470703 361514.95309570315 1.2790000438690186,43598.60899755859 361510.0461132813 1.2790000438690186)),((43603.770435546874 361514.6418164063 1.2790000438690186,43603.50600073242 361509.7590039063 6.764927387237549,43603.50600073242 361509.7590039063 1.2790000438690186,43603.770435546874 361514.6418164063 1.2790000438690186)),((43603.770435546874 361514.6418164063 1.2790000438690186,43603.770435546874 361514.6418164063 7.381703853607178,43603.50600073242 361509.7590039063 6.764927387237549,43603.770435546874 361514.6418164063 1.2790000438690186)),((43598.85057470703 361514.95309570315 1.2790000438690186,43599.11101171875 361520.242890625 6.854876518249512,43599.11101171875 361520.242890625 1.2790000438690186,43598.85057470703 361514.95309570315 1.2790000438690186)),((43598.85057470703 361514.95309570315 1.2790000438690186,43598.85057470703 361514.95309570315 7.397906303405762,43599.11101171875 361520.242890625 6.854876518249512,43598.85057470703 361514.95309570315 1.2790000438690186)),((43604.058002685546 361519.95211914065 6.836284160614014,43603.770435546874 361514.6418164063 7.381703853607178,43603.770435546874 361514.6418164063 1.2790000438690186,43604.058002685546 361519.95211914065 6.836284160614014)),((43604.058002685546 361519.95211914065 1.2790000438690186,43604.058002685546 361519.95211914065 6.836284160614014,43603.770435546874 361514.6418164063 1.2790000438690186,43604.058002685546 361519.95211914065 1.2790000438690186)),((43599.11101171875 361520.242890625 1.2790000438690186,43604.058002685546 361519.95211914065 6.836284160614014,43604.058002685546 361519.95211914065 1.2790000438690186,43599.11101171875 361520.242890625 1.2790000438690186)),((43599.11101171875 361520.242890625 1.2790000438690186,43599.11101171875 361520.242890625 6.854876518249512,43604.058002685546 361519.95211914065 6.836284160614014,43599.11101171875 361520.242890625 1.2790000438690186)),((43603.50600073242 361509.7590039063 6.764927387237549,43598.60899755859 361510.0461132813 6.778176307678223,43598.60899755859 361510.0461132813 1.2790000438690186,43603.50600073242 361509.7590039063 6.764927387237549)),((43603.50600073242 361509.7590039063 1.2790000438690186,43603.50600073242 361509.7590039063 6.764927387237549,43598.60899755859 361510.0461132813 1.2790000438690186,43603.50600073242 361509.7590039063 1.2790000438690186)),((43603.770435546874 361514.6418164063 7.381703853607178,43598.60899755859 361510.0461132813 6.778176307678223,43603.50600073242 361509.7590039063 6.764927387237549,43603.770435546874 361514.6418164063 7.381703853607178)),((43603.770435546874 361514.6418164063 7.381703853607178,43598.85057470703 361514.95309570315 7.397906303405762,43598.60899755859 361510.0461132813 6.778176307678223,43603.770435546874 361514.6418164063 7.381703853607178)),((43604.058002685546 361519.95211914065 6.836284160614014,43598.85057470703 361514.95309570315 7.397906303405762,43603.770435546874 361514.6418164063 7.381703853607178,43604.058002685546 361519.95211914065 6.836284160614014)),((43604.058002685546 361519.95211914065 6.836284160614014,43599.11101171875 361520.242890625 6.854876518249512,43598.85057470703 361514.95309570315 7.397906303405762,43604.058002685546 361519.95211914065 6.836284160614014)))";
            var multipolygon = (MultiPolygon)Wkx.Geometry.Deserialize<WktSerializer>(buildingWkt);
            var wkb = multipolygon.AsBinary();

            // act
            var wkbResult = Triangulator.Triangulate(wkb);
            var multipolygonResult = (MultiPolygon)Wkx.Geometry.Deserialize<WkbSerializer>(wkbResult);

            // assert
            Assert.IsTrue(multipolygonResult.Geometries.Count == multipolygon.Geometries.Count);
        }

        [Test]
        public void Issue1Test()
        {
            var testwkt = "MULTIPOLYGON Z(((30.356761255962184 59.93722647515295 27.871915817260742,30.356761954668244 59.937226473264715 27.839399337768555,30.356761954668244 59.937226473264715 27.871915817260742,30.356761255962184 59.93722647515295 27.871915817260742)),((30.356761954668244 59.937226473264715 27.839399337768555,30.356761255962184 59.93722647515295 27.871915817260742,30.356761255962184 59.93722647515295 27.839399337768555,30.356761954668244 59.937226473264715 27.839399337768555)),((30.356761954668244 59.937226473264715 27.839399337768555,30.356761255962184 59.93722647515295 27.839399337768555,30.356761954668244 59.937226473264715 26.844816207885742,30.356761954668244 59.937226473264715 27.839399337768555)),((30.356761954668244 59.937226473264715 27.871915817260742,30.356761954668244 59.937226473264715 27.839399337768555,30.356767683305314 59.93722638765955 27.839399337768555,30.356761954668244 59.937226473264715 27.871915817260742)),((30.356761954668244 59.937226473264715 27.871915817260742,30.356767683305314 59.93722638765955 27.839399337768555,30.356767683305314 59.93722638765955 27.871915817260742,30.356761954668244 59.937226473264715 27.871915817260742)),((30.356761954668244 59.937226473264715 27.871915817260742,30.356761954668244 59.937226473264715 28.19060707092285,30.356761255962184 59.93722647515295 28.19060707092285,30.356761954668244 59.937226473264715 27.871915817260742)),((30.356761255962184 59.93722647515295 27.871915817260742,30.356761954668244 59.937226473264715 27.871915817260742,30.356761255962184 59.93722647515295 28.19060707092285,30.356761255962184 59.93722647515295 27.871915817260742)),((30.356761255962184 59.93722647515295 27.839399337768555,30.356761255962184 59.93722647515295 27.871915817260742,30.35675580605493 59.93722648988101 27.871915817260742,30.356761255962184 59.93722647515295 27.839399337768555)),((30.356761255962184 59.93722647515295 27.839399337768555,30.35675580605493 59.93722648988101 27.871915817260742,30.35675580605493 59.93722648988101 27.839399337768555,30.356761255962184 59.93722647515295 27.839399337768555)),((30.356761954668244 59.937226473264715 26.844816207885742,30.356761255962184 59.93722647515295 27.839399337768555,30.356761255962184 59.93722647515295 26.844816207885742,30.356761954668244 59.937226473264715 26.844816207885742)),((30.356761251446663 59.937226054423675 27.839399337768555,30.356761950152713 59.93722605253543 27.871915817260742,30.356761950152713 59.93722605253543 27.839399337768555,30.356761251446663 59.937226054423675 27.839399337768555)),((30.356761950152713 59.93722605253543 27.871915817260742,30.356761251446663 59.937226054423675 27.839399337768555,30.356761251446663 59.937226054423675 27.871915817260742,30.356761950152713 59.93722605253543 27.871915817260742)),((30.356761251446663 59.937226054423675 27.839399337768555,30.356761950152713 59.93722605253543 27.839399337768555,30.356761251446663 59.937226054423675 26.844816207885742,30.356761251446663 59.937226054423675 27.839399337768555)),((30.356761251446663 59.937226054423675 27.871915817260742,30.356761251446663 59.937226054423675 27.839399337768555,30.356755801539475 59.93722606915172 27.839399337768555,30.356761251446663 59.937226054423675 27.871915817260742)),((30.356761251446663 59.937226054423675 27.871915817260742,30.356755801539475 59.93722606915172 27.839399337768555,30.356755801539475 59.93722606915172 27.871915817260742,30.356761251446663 59.937226054423675 27.871915817260742)),((30.356761251446663 59.937226054423675 27.871915817260742,30.356761251446663 59.937226054423675 28.19060707092285,30.356761950152713 59.93722605253543 28.19060707092285,30.356761251446663 59.937226054423675 27.871915817260742)),((30.356761950152713 59.93722605253543 27.871915817260742,30.356761251446663 59.937226054423675 27.871915817260742,30.356761950152713 59.93722605253543 28.19060707092285,30.356761950152713 59.93722605253543 27.871915817260742)),((30.356761950152713 59.93722605253543 27.839399337768555,30.356761950152713 59.93722605253543 27.871915817260742,30.3567676787897 59.93722596693028 27.871915817260742,30.356761950152713 59.93722605253543 27.839399337768555)),((30.356761950152713 59.93722605253543 27.839399337768555,30.3567676787897 59.93722596693028 27.871915817260742,30.3567676787897 59.93722596693028 27.839399337768555,30.356761950152713 59.93722605253543 27.839399337768555)),((30.356761251446663 59.937226054423675 26.844816207885742,30.356761950152713 59.93722605253543 27.839399337768555,30.356761950152713 59.93722605253543 26.844816207885742,30.356761251446663 59.937226054423675 26.844816207885742)),((30.356761954668244 59.937226473264715 27.839399337768555,30.356761954668244 59.937226473264715 26.844816207885742,30.356761950152713 59.93722605253543 26.844816207885742,30.356761954668244 59.937226473264715 27.839399337768555)),((30.356761954668244 59.937226473264715 27.839399337768555,30.356761950152713 59.93722605253543 26.844816207885742,30.356761950152713 59.93722605253543 27.839399337768555,30.356761954668244 59.937226473264715 27.839399337768555)),((30.356767683305314 59.93722638765955 27.839399337768555,30.356761954668244 59.937226473264715 27.839399337768555,30.356761950152713 59.93722605253543 27.839399337768555,30.356767683305314 59.93722638765955 27.839399337768555)),((30.356767683305314 59.93722638765955 27.839399337768555,30.356761950152713 59.93722605253543 27.839399337768555,30.3567676787897 59.93722596693028 27.839399337768555,30.356767683305314 59.93722638765955 27.839399337768555)),((30.356767683305314 59.93722638765955 27.871915817260742,30.356767683305314 59.93722638765955 27.839399337768555,30.3567676787897 59.93722596693028 27.839399337768555,30.356767683305314 59.93722638765955 27.871915817260742)),((30.356767683305314 59.93722638765955 27.871915817260742,30.3567676787897 59.93722596693028 27.839399337768555,30.3567676787897 59.93722596693028 27.871915817260742,30.356767683305314 59.93722638765955 27.871915817260742)),((30.356761954668244 59.937226473264715 27.871915817260742,30.356767683305314 59.93722638765955 27.871915817260742,30.3567676787897 59.93722596693028 27.871915817260742,30.356761954668244 59.937226473264715 27.871915817260742)),((30.356761954668244 59.937226473264715 27.871915817260742,30.3567676787897 59.93722596693028 27.871915817260742,30.356761950152713 59.93722605253543 27.871915817260742,30.356761954668244 59.937226473264715 27.871915817260742)),((30.356761954668244 59.937226473264715 28.19060707092285,30.356761954668244 59.937226473264715 27.871915817260742,30.356761950152713 59.93722605253543 27.871915817260742,30.356761954668244 59.937226473264715 28.19060707092285)),((30.356761954668244 59.937226473264715 28.19060707092285,30.356761950152713 59.93722605253543 27.871915817260742,30.356761950152713 59.93722605253543 28.19060707092285,30.356761954668244 59.937226473264715 28.19060707092285)),((30.356761255962184 59.93722647515295 28.19060707092285,30.356761954668244 59.937226473264715 28.19060707092285,30.356761950152713 59.93722605253543 28.19060707092285,30.356761255962184 59.93722647515295 28.19060707092285)),((30.356761255962184 59.93722647515295 28.19060707092285,30.356761950152713 59.93722605253543 28.19060707092285,30.356761251446663 59.937226054423675 28.19060707092285,30.356761255962184 59.93722647515295 28.19060707092285)),((30.356761255962184 59.93722647515295 27.871915817260742,30.356761255962184 59.93722647515295 28.19060707092285,30.356761251446663 59.937226054423675 28.19060707092285,30.356761255962184 59.93722647515295 27.871915817260742)),((30.356761255962184 59.93722647515295 27.871915817260742,30.356761251446663 59.937226054423675 28.19060707092285,30.356761251446663 59.937226054423675 27.871915817260742,30.356761255962184 59.93722647515295 27.871915817260742)),((30.35675580605493 59.93722648988101 27.871915817260742,30.356761255962184 59.93722647515295 27.871915817260742,30.356761251446663 59.937226054423675 27.871915817260742,30.35675580605493 59.93722648988101 27.871915817260742)),((30.35675580605493 59.93722648988101 27.871915817260742,30.356761251446663 59.937226054423675 27.871915817260742,30.356755801539475 59.93722606915172 27.871915817260742,30.35675580605493 59.93722648988101 27.871915817260742)),((30.35675580605493 59.93722648988101 27.839399337768555,30.35675580605493 59.93722648988101 27.871915817260742,30.356755801539475 59.93722606915172 27.871915817260742,30.35675580605493 59.93722648988101 27.839399337768555)),((30.35675580605493 59.93722648988101 27.839399337768555,30.356755801539475 59.93722606915172 27.871915817260742,30.356755801539475 59.93722606915172 27.839399337768555,30.35675580605493 59.93722648988101 27.839399337768555)),((30.356761255962184 59.93722647515295 27.839399337768555,30.35675580605493 59.93722648988101 27.839399337768555,30.356755801539475 59.93722606915172 27.839399337768555,30.356761255962184 59.93722647515295 27.839399337768555)),((30.356761255962184 59.93722647515295 27.839399337768555,30.356755801539475 59.93722606915172 27.839399337768555,30.356761251446663 59.937226054423675 27.839399337768555,30.356761255962184 59.93722647515295 27.839399337768555)),((30.356761255962184 59.93722647515295 26.844816207885742,30.356761255962184 59.93722647515295 27.839399337768555,30.356761251446663 59.937226054423675 27.839399337768555,30.356761255962184 59.93722647515295 26.844816207885742)),((30.356761255962184 59.93722647515295 26.844816207885742,30.356761251446663 59.937226054423675 27.839399337768555,30.356761251446663 59.937226054423675 26.844816207885742,30.356761255962184 59.93722647515295 26.844816207885742)),((30.356761954668244 59.937226473264715 26.844816207885742,30.356761255962184 59.93722647515295 26.844816207885742,30.356761251446663 59.937226054423675 26.844816207885742,30.356761954668244 59.937226473264715 26.844816207885742)),((30.356761954668244 59.937226473264715 26.844816207885742,30.356761251446663 59.937226054423675 26.844816207885742,30.356761950152713 59.93722605253543 26.844816207885742,30.356761954668244 59.937226473264715 26.844816207885742)),((30.35676083899632 59.93722668665053 26.67998504638672,30.35676083899632 59.93722668665053 26.847633361816406,30.356760829965275 59.93722584519197 26.847633361816406,30.35676083899632 59.93722668665053 26.67998504638672)),((30.35676083899632 59.93722668665053 26.67998504638672,30.356760829965275 59.93722584519197 26.847633361816406,30.356760829965275 59.93722584519197 26.67998504638672,30.35676083899632 59.93722668665053 26.67998504638672)),((30.356762515890864 59.93722668211878 26.67998504638672,30.356762515890864 59.93722668211878 26.847633361816406,30.35676083899632 59.93722668665053 26.847633361816406,30.356762515890864 59.93722668211878 26.67998504638672)),((30.356762515890864 59.93722668211878 26.67998504638672,30.35676083899632 59.93722668665053 26.847633361816406,30.35676083899632 59.93722668665053 26.67998504638672,30.356762515890864 59.93722668211878 26.67998504638672)),((30.356762506859774 59.9372258406602 26.67998504638672,30.356762506859774 59.9372258406602 26.847633361816406,30.356762515890864 59.93722668211878 26.847633361816406,30.356762506859774 59.9372258406602 26.67998504638672)),((30.356762506859774 59.9372258406602 26.67998504638672,30.356762515890864 59.93722668211878 26.847633361816406,30.356762515890864 59.93722668211878 26.67998504638672,30.356762506859774 59.9372258406602 26.67998504638672)),((30.356760829965275 59.93722584519197 26.67998504638672,30.356760829965275 59.93722584519197 26.847633361816406,30.356762506859774 59.9372258406602 26.847633361816406,30.356760829965275 59.93722584519197 26.67998504638672)),((30.356760829965275 59.93722584519197 26.67998504638672,30.356762506859774 59.9372258406602 26.847633361816406,30.356762506859774 59.9372258406602 26.67998504638672,30.356760829965275 59.93722584519197 26.67998504638672)),((30.35676083899632 59.93722668665053 26.847633361816406,30.356762515890864 59.93722668211878 26.847633361816406,30.356762506859774 59.9372258406602 26.847633361816406,30.35676083899632 59.93722668665053 26.847633361816406)),((30.35676083899632 59.93722668665053 26.847633361816406,30.356762506859774 59.9372258406602 26.847633361816406,30.356760829965275 59.93722584519197 26.847633361816406,30.35676083899632 59.93722668665053 26.847633361816406)),((30.356760829965275 59.93722584519197 26.67998504638672,30.356762506859774 59.9372258406602 26.67998504638672,30.356762515890864 59.93722668211878 26.67998504638672,30.356760829965275 59.93722584519197 26.67998504638672)),((30.356760829965275 59.93722584519197 26.67998504638672,30.356762515890864 59.93722668211878 26.67998504638672,30.35676083899632 59.93722668665053 26.67998504638672,30.356760829965275 59.93722584519197 26.67998504638672)))";
            var wkt = Geometry.Deserialize<WktSerializer>(testwkt);
            var wkb = wkt.AsBinary();
            var inputMultipolygon = (MultiPolygon)wkt;
            var bytes = Triangulator.Triangulate(wkb);
            var multipolygon = (MultiPolygon)Geometry.Deserialize<WkbSerializer>(bytes);
            Assert.IsTrue(inputMultipolygon.Geometries.Count == multipolygon.Geometries.Count);
        }

        [Test]
        public void TriangulateCubeTest()
        {
            // arrange
            var cubeWkt = "POLYHEDRALSURFACE Z (((0 0 0, 0 1 0, 1 1 0, 1 0 0, 0 0 0)),((0 0 0, 0 1 0, 0 1 1, 0 0 1, 0 0 0)), ((0 0 0, 1 0 0, 1 0 1, 0 0 1, 0 0 0)), ((1 1 1, 1 0 1, 0 0 1, 0 1 1, 1 1 1)),((1 1 1, 1 0 1, 1 0 0, 1 1 0, 1 1 1)),((1 1 1, 1 1 0, 0 1 0, 0 1 1, 1 1 1)))";
            var expectedResult = "POLYHEDRALSURFACE Z (((0 1 0,1 1 0,1 0 0,0 1 0)),((0 1 0,1 0 0,0 0 0,0 1 0)),((0 1 0,0 1 1,0 0 1,0 1 0)),((0 1 0,0 0 1,0 0 0,0 1 0)),((1 0 0,1 0 1,0 0 1,1 0 0)),((1 0 0,0 0 1,0 0 0,1 0 0)),((1 0 1,0 0 1,0 1 1,1 0 1)),((1 0 1,0 1 1,1 1 1,1 0 1)),((1 0 1,1 0 0,1 1 0,1 0 1)),((1 0 1,1 1 0,1 1 1,1 0 1)),((1 1 0,0 1 0,0 1 1,1 1 0)),((1 1 0,0 1 1,1 1 1,1 1 0)))";
            var wkt = Geometry.Deserialize<WktSerializer>(cubeWkt);
            var wkb = wkt.AsBinary();

            // act
            var bytes = Triangulator.Triangulate(wkb);

            // assert
            var wkbResult = Geometry.Deserialize<WkbSerializer>(bytes);
            var polyhedralsurface_after_wkt = wkbResult.AsText();
            Assert.IsTrue(expectedResult == polyhedralsurface_after_wkt);
        }

        [Test]
        public void TriangulateWkbTest()
        {
            // arrange
            var buildingWkb = File.ReadAllBytes(@"testdata/building.wkb");

            // act
            var wkbTriangulated = Triangulator.Triangulate(buildingWkb);
            
            // assert
            var polyhedral = (PolyhedralSurface)Geometry.Deserialize<WkbSerializer>(wkbTriangulated);
            Assert.IsTrue(polyhedral.Geometries.Count == 22);

            GltfCreator.CreateGltf(polyhedral, @"wkb.gltf");
        }
    }
}